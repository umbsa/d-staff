# アプリケーション詳細

## アプリケーション名
d-staff

## アプリケーションの概要
「宅配サービスを使うにあたって悪意のある人間が来るかもしれない」といったユーザーの不安の声を解消するために開発しました。
このアプリケーションではプロフィールで配達員の人となりや顔写真を見てから指名することで、安心して宅配サービスを利用できると考え制作に及びました。

# アプリケーションの利用方法

## URL
https://d-staff.herokuapp.com/

## テスト用アカウント
Basic認証のID/Pass sato/2233  
管理者アカウントのEmail/Pass admin@example/1234567a  
クレジットカードのテスト番号/CVC/有効期限 4242424242424242/123/今よりも未来

## 具体的な利用方法
1. トップページヘッダーのログインボタンから上記管理者アカウントのEmailとPasswordを入力することで管理者権限を持ったアカウントでログインすることができます。また、新規登録ボタンから通常アカウントとして新規登録ができます。ログインしているときはヘッダー右に「現在ログイン中のユーザーの名前」が出現します、クリックすることでクレジットカード登録の画面に遷移します。すでに登録してある場合はマイページに遷移して、ユーザーの情報を編集することができます。クレジットカード登録の際は上記のテスト番号をお使いください。

2. 管理者としてログインしているときにはヘッダー左に「スタッフ情報投稿」と「予約確認」が出現します。「スタッフ情報投稿」をクリックしていただきますと配達員の画像、名前、歴、コメント、趣味、そして配達料を入力するフォームが出ますので入力して「登録する」ボタンを押してください。

3. トップページに先ほど入力したスタッフが一覧で表示され、スタッフをクリックするとスタッフ詳細ページに遷移します。管理者アカウントにログインした状態だとスタッフの情報を「編集」するボタンと「削除」するボタンが出現し、通常アカウントにログインした状態だと「指名して予約」ボタンが出現します。「指名して予約」をクリックしますと予約ページに遷移します。

4. 予約日と配達先住所を入力して「送信」を押すと予約完了メールが登録したメールアドレスに送られ、そのあと決済方法確認ページに遷移します。このページではすでにクレジットカードを登録している場合は「クレジットでのお支払いをご希望のお客様はこちらから 購入を確定」の文字が現れ、クレジットカードの登録が済んでいない場合は「クレジットカードの登録がお済みでない方はこちらからご登録ください カード登録」の文字が現れます。前者の場合には「購入を確定」を押すことで決済が完了し、後者の場合は一度クレジットカード登録画面に遷移し、登録後に再び決済方法確認ページに帰ってきますのでそこで「購入を確定」を押すことで決済が完了します。クレジットカード登録の際は上記のテスト番号をお使いください。

5. 管理者はヘッダー左の「予約確認」をクリックすることでカレンダー形式で予約状況を確認できます、さらにユーザーの名前をクリックすることで、配達日時、配達先住所、そして電話番号を確認することができます。

6. トップページヘッダーにはスタッフの名前を検索できるバーが設けてあります。

# 要件定義

## 目指した課題解決
配達スタッフに対して不安を感じている人が安心して宅配サービスを利用するためのサービスを作ること。

## ①スタッフ詳細・編集・削除機能
目的: 配達スタッフの画像や趣味、配達員歴、コメントを見ることで安心感を得ることができるということ。  
詳細: 管理者アカウントと通常アカウントで表示内容を変えることで視認性を高めています。

## ②予約機能
目的: ユーザーと管理者両方にとって分かりやすく予約機能を実装すること。  
詳細: Simple Calendarを用いて予約機能を実装しました、これによって管理者はいつ、どこに、誰が配達に行けばいいのか一目でわかるようになっています。

## ③メール送信機能
目的: ユーザーが予約が確定したことを確認するため。  
詳細: Action Mailerを用いることでメール送信機能を実装しました。これによってユーザーはメールを確認することで配達日時と配達スタッフの名前を確認することができます。

## ④クレジットカード登録機能
目的: クレジットカードを登録して保存しておくことで、決済を現金かクレジットカードかで選ぶことができるようにするため。  
詳細: PAY.JPというクレジットカード決済代行サービスを用いること、またJavaScriptを用いることで実装しました。

## ⑤スタッフ検索機能
目的: ユーザーが再び同じスタッフを指名したい場合などにすぐ見つけられるようにするため。  
詳細: 検索した言葉が含まれているスタッフを一覧表示されるよう実装しました。

## ⑥エラー文の表示と日本語化
目的: フォームに間違えた情報や空の情報を入力した際に何がいけなくて登録できないのかを視覚化するため、また日本人に向けたサービスであるため日本語化をするため。  
詳細: エラー文は部分テンプレートを利用することで複数のページに流用できるように実装した。また、rails-i18nというGemを導入することで日本語化を実装した。

## ⑦ユーザー管理機能
目的: 配達するためにはユーザーの情報が不可欠であるため  
詳細: deviceを導入することでユーザー管理機能を実装しました。ユーザーの情報はメール送信機能にて名前を用いるなど、さまざまなページで表示させています。

## ⑧スタッフ画像のリンク切れを防ぐための機能
目的: リンク切れしてしまうと肝心のスタッフの顔写真が見られなくなってしまうため。  
詳細: Amazon S3を導入することでリンク切れを防ぐことができました。また、AWSを利用する際には二段階認証を導入することでセキュリティを担保しています。

## ⑨都道府県入力フォーム
目的: 基本的に変更されないデータを毎回データベースに保存しないため。  
詳細: ActiveHashを用いることで実装しました。モデルファイル内に直接記述することでActiveRecordのようなメソッドを用いることができます。(例:all,createメソッド)

## 今後実装する予定の機能

## ①グッドボタンとバッドボタン
目的: スタッフの就業態度改善や、給料アップの指針にするため。  

## ②スタッフレビュー機能
目的: ユーザーがスタッフを選ぶときの判断基準になるため。  

## ③レスポンシブ化
目的: スマートフォンやタブレットでサイトを閲覧することが主流となっている時代の流れに合わせる必要があるため  



# テーブル設計

## users テーブル

| Column             | Type    | Options                   |
| ------------------ | ------- | ------------------------- |
| nickname           | string  | null: false,              |
| email              | string  | null: false, unique: true |
| encrypted_password | string  | null: false               |
| full_name          | string  | null: false               |
| full_name_kana     | string  | null: false               |
| user_birth_date    | date    | null: false               |

### Association

- has_many :verifications
- has_many :reservations
- has_one :card, dependent: :destroy

## staffs テーブル

| Column                        | Type       | Options                        |
| ----------------------------- | ---------- | ------------------------------ |
| name                          | string     | null: false                    |
| history                       | text       | null: false                    |
| comment                       | string     | null: false                    |
| hobby                         | text       | null: false                    |
| price                         | references | null: false, foreign_key: true |
| Active Storageにて画像投稿を実装 |            |                                |

### Association

- has_many :verifications
- has_many :reservations
- has_one :staff_order

## staff_orders テーブル

| Column | Type       | Options                        |
| ------ | ---------- | ------------------------------ |
| staff  | references | null: false, foreign_key: true |


### Association

- belongs_to :staff


## reservations テーブル

| Column        | Type       | Options                        |
| ------------- | ---------- | ------------------------------ |
| start_time    | datetime   |                                |
| postal_code   | string     | null: false                    |
| prefecture_id | integer    | null: false                    |
| city          | string     | null: false                    |
| addresses     | string     | null: false                    |
| building      | string     |                                |
| phone_number  | string     | null: false                    |
| staff         | references | null: false, foreign_key: true |
| user          | references | null: false, foreign_key: true |

### Association

- belongs_to :staff
- belongs_to :user

## cards テーブル

| Column                | Type       | Options                        |
| --------------------- | ---------- | ------------------------------ |
| card_token            | string     | null: false                    |
| customer_token        | string     | null: false                    |
| user                  | references | null: false, foreign_key: true |

### Association

- belongs_to :user

## ER図
https://gyazo.com/95326d2f880fc3c7f8ca631cc1d6b66c

## ローカルでの動作方法
以下の手順で動作できるかと思います。  

% git clone https://github.com/umbsa/d-staff.git % cd d-staff % bundle install % rails db:create % rails db:migrate % rails db:seed  

railsはバージョン6.0.0を使用しています

